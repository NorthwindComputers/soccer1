<?php
/************************************
 * Order review screen before final 
 * placement of order in system     
 *                                  
 * Version: 1.9.9.1            
 * Updated: 30 December 2014            
 * By: Richard Tuttle               
 ***********************************/
 
// header('Expires: Sun, 01 Jan 2014 00:00:00 GMT');
// header('Cache-Control: no-store, no-cache, must-revalidate');
// header('Cache-Control: post-check=0, pre-check=0', FALSE);
// header('Pragma: no-cache'); 
 
require_once 'cpadmin/includes/db.php';
session_start();
require_once 'includes/inc_calcVipprice.php';
require_once 'includes/CouponCalculation.php';

$cusTotalProduct = 0;
$submitted = 0;
$ot = number_format($_POST["ordertotal"], 2);
$td = number_format($_POST['totaldiscount'], 2);
//$ts = number_format($_POST['totalshipping'], 2);
$tt = number_format($_POST['totaltax'], 2);
$gt = number_format($_POST['grandtotal'], 2);
$shipping = mysql_real_escape_string($_POST["shipping"]);
$isvip = mysql_real_escape_string($_POST["isvip"]);
$paymentMethod = mysql_real_escape_string($_POST['paymentmethod']);
$cardNum = mysql_real_escape_string($_POST["CardNumber"]);
//$ot = mysql_real_escape_string($_POST["ordertotal"]);
//$td = mysql_real_escape_string($_POST['totaldiscount']);
//$tt = mysql_real_escape_string($_POST['totaltax']);
$ts = mysql_real_escape_string($_POST['totalshipping']);
$ship = mysql_real_escape_string($_POST['shipping']);
//$gt = mysql_real_escape_string($_POST['grandtotal']);
$ct = mysql_real_escape_string($_POST['CardType']);
$noc = mysql_real_escape_string($_POST['NameOnCard']);
$ed = mysql_real_escape_string($_POST['ExpDate']);
$sc = mysql_real_escape_string($_POST['SecurityCode']);
$notes = mysql_real_escape_string($_POST['orderNotes']);
$wt = mysql_real_escape_string($_POST['Weight']);
$submitted = mysql_real_escape_string($_POST['submitted']);
$gcNum = mysql_real_escape_string($_POST['gcNum']);

if (isset($_SESSION["email"])) {
	if (isset($shipping)) {
		// choose pricing based on vip status
		if ($isvip == "yes") {
			$unitprice = "VIPPrice";
		} else {
			$unitprice = "Price";
		}

// create random GC number
function generateGCnum($length = 10) {
	$characters = "0123456789";
	$randomString = '';
	for ($i = 0; $i < $length; $i++) {
		$randomString .= $characters[rand(0, strlen($characters) - 1)];
	}
	return $randomString;
}
      
if ($submitted == 1) {
	// paying with a credit card
	if (($paymentMethod != "OpenAccount") || ($paymentMethod != "gcOnly")) {
		$cardNumSafe = "XXXX-XXXX-XXXX-" . substr($cardNum,-4,4); // secure card info
		$sql_order  = "INSERT INTO orders(EmailAddress, OrderDate, OrderStatus, OrderTotal, Discount, Tax, ShippingTotal, ShippingMethod, GrandTotal, CardType, NameOnCard, CCNum, ExpDate, SecurityCode, OrderNotes, WeightTotal, referrer) ";
		$sql_order .= "VALUES('$_SESSION[email]', current_date, 'Pending', '$ot', '$td', '$tt', '$ts', '$ship', '$gt', '$ct', '$noc', '$cardNumSafe', '$ed', '$sc', '$notes', '$wt', '$_SESSION[org_referrer]')";	
	} elseif ($paymentMethod = "gcOnly") {
	    $sql_order  = "INSERT INTO orders(EmailAddress, OrderDate, OrderStatus, OrderTotal, Discount, Tax, ShippingTotal, ShippingMethod, GrandTotal, CardType, OrderNotes, WeightTotal, referrer) ";
		$sql_order .= "VALUES('$_SESSION[email]', current_date, 'Pending', '$ot', '$td', '$tt', '$ts', '$ship', '$gt', 'Gift Certificate funds', '$notes', '$wt', '$_SESSION[org_referrer]')";	
	} else {
		// paying with an open account
		$sql_order = "INSERT INTO orders(EmailAddress, OrderDate, OrderStatus, OrderTotal, Discount, Tax, ShippingTotal, ShippingMethod, GrandTotal, CardType, OrderNotes, WeightTotal, referrer) ";
		$sql_order .= "VALUES('$_SESSION[email]', current_date, 'Pending', '$ot', '$td', '$tt', '$ts', '$ship', '$gt', 'OpenAccount', '$notes', '$wt', '$_SESSION[org_referrer]')";
	}
	// echo "SQL: " . $sql_order; exit;	// testing use only
	if (!mysql_query($sql_order)) {
		echo "error saving order: ".mysql_error();
	} else {
		$orderid = mysql_insert_id();
		$sql_items = "SELECT * FROM shopping_cart WHERE (SessionID='".session_id()."' OR EmailAddress='$_SESSION[email]') AND (BundleID='' OR BundleID IS NULL)";
		$result_items = mysql_query($sql_items);
		while ($row_items = mysql_fetch_array($result_items)) {
			if (($row_items['Type'] == 'Coupon') || ($row_items['Type'] == 'GC')) {
				$row_items[$unitprice] = $td;
			}
			$row_items['GenderSKU'] = addslashes($row_items['GenderSKU']);
			$row_items['RootSKU'] = addslashes($row_items['RootSKU']);
			$row_items['SizeSKU'] = addslashes($row_items['SizeSKU']);
			$row_items['ColorSKU'] = addslashes($row_items['ColorSKU']);
			$row_items['ProductName'] = addslashes($row_items['ProductName']);

			// insert Ordered Items into the database
			if ($row_items["Type"] != "CouponUsed") {
				// if ($row_items["Type"] != "Cert") {
				$sql_additem  = "INSERT INTO orders_items(OrderID, ProductID, ProductName, RootSKU, SizeSKU, ColorSKU, Qty, Gender, GenderSKU, Price, Type) ";
				$sql_additem .= "VALUES($orderid, '$row_items[ProductID]', '$row_items[ProductName]', '$row_items[RootSKU]', '$row_items[SizeSKU]', '$row_items[ColorSKU]', '$row_items[Qty]', '".addslashes($row_items['Gender'])."', '$row_items[GenderSKU]', '$row_items[$unitprice]', '$row_items[Type]')";
				// echo "SQL: " . $sql_additem . "<br />"; exit;
				mysql_query($sql_additem) or die("Orders Items Insertion Error: " . mysql_error());
				
				// did customer purchase a GC?
			    $x = 1;
			    while ($x <= $row_items['Qty']) {
				    $buyGC = $row_items["RootSKU"];
				    $value = $row_items['Price'];
				    $z = substr($buyGC, 0, 3);
				    $newGCnum = "GC-";
				    if ($z == "GC-") {
					    $newGCnum .= generateGCnum();
					    // check for duplication GC number before insertion
					    $ckNum = mysql_query("SELECT DISTINCT codeNum FROM certificate WHERE certType='gift' AND codeNum='$newGCnum'");
					    if (mysql_num_rows($ckNum) > 0) {
						    $newGCnum = "GC-";
						    $newGCnum .= generateGCnum();
					    }
					    // add new GC to database 	
					    $temp = $newGCnum + $value + generateGCnum();
					    $hashcode = md5($temp);
					    $sql_addGC = "INSERT INTO certificate(certType, codeNum, origValue, used, remainValue, hash) VALUES('gift', '$newGCnum', '$value', 'no', '$value', '$hashcode')";
					    // echo "--== DEBUG ==--<br>temp = " . $temp . "<br>hashcode = " . $hashcode . "<br>SQL: " . $sql_addGC; exit(); // testing only
					    if (mysql_query($sql_addGC)) {
						    // create new GC PDF and send customer email about GC
						    $gcHeaders = "MIME-Version: 1.0\r\n";
						    $gcHeaders .= "From: SoccerOne Customer Service <customerservice@soccerone.com>\r\n"; 
						    $gcHeaders .= "Content-type: text/html; charset: utf8\r\n"; 
						    $gcHeaders .= "Reply-To: SoccerOne <customerservice@soccerone.com>\r\n";
						    $gcHeaders .= "X-Mailer: PHP/" . phpversion() . "\r\n";
						    $gcSubject = "SoccerOne Gift Certificate";
						    $gcMsg = "<h2>Gift Certificate Purchased</h2>To view and/or print your SoccerOne Gift Certificate, please click this link: <a href='https://www.soccerone.net/giftcert.php?h=$hashcode'>YOUR SOCCERONE GIFT CERTIFICATE IS READY!</a><br><br><br><i>------ Gift Certificate Details --------</i><br>Certificate Number: $newGCnum<br>Certificate Value: \$$value<br>Expiration Date: Never<br>----------------------------------------------";
						    mail($_SESSION['email'], $gcSubject, $gcMsg, $gcHeaders, '-f customerservice@soccerone.com'); // send order email to customer
						    $value = 0;
						    $newGCnum = 0;
					    } else {
						    die("New Certificate Insertion Error: " . mysql_error()); exit;
					    }
				    }
				    $x++;
			    }
				
				// check for used GC and update that info in database
				if ($row_items["Type"] == "GC") {
					// get orderUsedIDs from certificate column, if applicable
					$ckCert = "SELECT DISTINCT * FROM certificate WHERE codeNum='$row_items[ProductID]' AND certType='gift'";
					$resultCert = mysql_query($ckCert);
					$resCert = mysql_fetch_assoc($resultCert);
					if ($resCert["orderUsedID"] == '' || $resCert["orderUsedID"] ==	NULL) {	
					    $sql_certUpdate = "UPDATE certificate SET orderUsedID='$orderid'";
					} else {
						$sql_certUpdate = "UPDATE certificate SET orderUsedID=CONCAT_WS(',', orderUsedID, '$orderid')";
					}
					// if ($_POST["GC"] == 1) {
						$currentTotal = $ot + $ship + $tt;
						if ($td > $currentTotal) {
							$remain = $td - $currentTotal;
							$rmV = number_format($remain, 2);
							$sql_certUpdate .= ", remainValue='$rmV'";
						} else {
							$sql_certUpdate .= ", remainValue='0', used='yes'";
						}
					// }
					$sql_certUpdate .= " WHERE codeNum='" . $row_items["ProductID"] . "'";
					// echo "SQL: " . $sql_certUpdate; exit(); // testing only
					$result_certUpdate = mysql_query($sql_certUpdate);
					if (!$result_certUpdate) { 
						die("ERROR UPDATING CERTIFICATE FILE DATA: " . mysql_error()); 
					}
				}
			}		
			// }	 
			$lastid = mysql_insert_id(); // get Order ID
			
			// if Bundle product insert into Order Items table
			if ($row_items["Type"] == "Bundle") {
				$sql_bitems = "SELECT * FROM shopping_cart WHERE BundleID=$row_items[id]";
				$result_bitems = mysql_query($sql_bitems);
				while ($row_bitems = mysql_fetch_array($result_bitems)) {
					$sql_addbitem = "INSERT INTO orders_items(OrderID, ProductID, ProductName, RootSKU, SizeSKU, ColorSKU, Qty, Gender, `Type`, BundleID) ";
					$sql_addbitem .= "VALUES($orderid, '$row_bitems[ProductID]', '$row_bitems[ProductName]', '$row_bitems[RootSKU]', '$row_bitems[SizeSKU]', '$row_bitems[ColorSKU]', '$row_bitems[Qty]', '$row_bitems[Gender]', 'Bundle', $lastid)";

					if (!mysql_query($sql_addbitem)) {
						echo $sql_addbitem."<br/>";
						echo "error adding items: ".mysql_error();
					}
				}
			}
				
			// check for single bundle items
			$sql_cksb = "SELECT * FROM shopping_cart_single WHERE singleid=$row_items[id]";
			$result_cksb = mysql_query($sql_cksb);
			while ($row_cksb = mysql_fetch_array($result_cksb)) {
				$sql_addsb = "INSERT INTO orders_items(OrderID, ProductID, ProductName, RootSKU, SizeSKU, ColorSKU, Qty, Gender, `Type`, BundleID) ";
				$sql_addsb .= "VALUES($orderid, '$row_cksb[ProductID]', '$row_cksb[ProductName]', '$row_cksb[RootSKU]', '$row_cksb[SizeSKU]', '$row_cksb[ColorSKU]', '$row_cksb[Qty]', '$row_cksb[Gender]', 'Single', $lastid)";
					
				if (!mysql_query($sql_addsb)) {
					echo "Error adding item: " . mysql_error();
				}
			}
				
			// update stock quantities
			if ($row_items["Type"] == "Product") {
				// check if stock is manageable
				$manageSQL = "SELECT ManagableStock FROM products WHERE id='$row_items[ProductID]' LIMIT 1";
				$manageResult = mysql_query($manageSQL) or die("Manage Stock Error: " . mysql_error());
				$manageChk = mysql_fetch_array($manageResult);
				if ($manageChk["ManagableStock"] == "Yes") {
					$sql_updateqty = "UPDATE product_options SET Inventory=(Inventory-$row_items[Qty]) WHERE ProductID=$row_items[ProductID] AND ColorSKU='$row_items[ColorSKU]' AND SizeSKU='$row_items[SizeSKU]' LIMIT 1";
					// echo "SQL: " . $sql_updateqty; exit; // testing use only
					mysql_query($sql_updateqty) or die("Qty Update Error: " . mysql_error());
					$sql_availQty = "UPDATE products SET AvailableQty = (SELECT SUM(Inventory) AS Stock FROM product_options WHERE ProductID=$row_items[ProductID]) WHERE id=$row_items[ProductID] LIMIT 1";
					// echo "SQL: " . $sql_availQty; exit; // testing use only
					mysql_query($sql_availQty) or die("Availability Error: " . mysql_error());
				}
			}
				
			// SAVE IMPRINT TO ORDER
			$sql_imprint = "SELECT * FROM imprint_shopping_cart WHERE CartID=$row_items[id]";
			$result_imprint = mysql_query($sql_imprint);
			while ($row_imprint = mysql_fetch_array($result_imprint)) {
				$sql_addimp  = "INSERT INTO imprint_orders(EmailAddress, OrderNumber, OrderItemID, OrderDate, ProductID, ImprintPrice, Opt1Type, Opt1Image, Opt1Color, Opt1Loc, Opt1Text, Opt1Team, Opt2Type, Opt2Image, Opt2Color, Opt2Loc, Opt2Text, Opt2Team) ";
				$sql_addimp .= "VALUES('$_SESSION[email]', '$orderid', '$lastid', current_date, '$row_items[ProductID]', $row_imprint[ImprintPrice], '$row_imprint[Opt1Type]', '$row_imprint[Opt1Image]', '$row_imprint[Opt1Color]', '$row_imprint[Opt1Loc]', '$row_imprint[Opt1Text]', '$row_imprint[Opt1Team]', '$row_imprint[Opt2Type]', '$row_imprint[Opt2Image]', '$row_imprint[Opt2Color]', '$row_imprint[Opt2Loc]', '$row_imprint[Opt2Text]', '$row_imprint[Opt2Team]')";
				mysql_query($sql_addimp) or die("Imprint Save Error: " . mysql_error());
			}
			
			// REMOVE IMPRINT DATA FROM CART 
			$sql_remimp = "DELETE FROM imprint_shopping_cart WHERE CartID=$row_items[id]";
			mysql_query($sql_remimp) or die("Imprint Removal Error: " . mysql_error());
		} // end while
		 
		// empty shopping cart after adding ordered items to the database
		$sql_removeitems = "DELETE FROM shopping_cart WHERE SessionID='".session_id()."' OR EmailAddress='$_SESSION[email]'";
		mysql_query($sql_removeitems) or die("Emptying Cart Error: " . mysql_error());

		// add ordering information to the Orders Address database
		$sql_address = "SELECT * FROM shopping_address WHERE SessionID='".session_id()."' LIMIT 1";
		$result_address = mysql_query($sql_address);
		$row_address = mysql_fetch_assoc($result_address);
		$sql_addaddress  = "INSERT INTO orders_address(OrderID, BillingFirstName, BillingLastName, BillingCompany, BillingEmailAddress, BillingAddress, BillingCity, BillingState, BillingZip, ShippingFirstName, ShippingLastName, ShippingCompany, ShippingEmailAddress, ShippingAddress, ShippingCity, ShippingState, ShippingZip) ";
		$sql_addaddress .= "VALUES($orderid, '$row_address[BillingFirstName]', '$row_address[BillingLastName]', '$row_address[BillingCompany]', '$row_address[BillingEmailAddress]', '$row_address[BillingAddress]', '$row_address[BillingCity]', '$row_address[BillingState]', '$row_address[BillingZip]', ";
		$sql_addaddress .= "'$row_address[ShippingFirstName]', '$row_address[ShippingLastName]', '$row_address[ShippingCompany]', '$row_address[ShippingEmailAddress]', '$row_address[ShippingAddress]', '$row_address[ShippingCity]', '$row_address[ShippingState]', '$row_address[ShippingZip]')";
		$customerName = $row_address["BillingFirstName"] . " " . $row_address["BillingLastName"];
		mysql_query($sql_addaddress);
		$sql_removeaddress = "DELETE FROM shopping_address WHERE SessionID='".session_id()."' OR EmailAddress='$_SESSION[email]'";
		mysql_query($sql_removeaddress);

		// is the customer a VIP?
		if($isvip == "yes") {
			$sql_cust = "SELECT * FROM customers WHERE EmailAddress='$_SESSION[email]' LIMIT 1";
			$result_cust = mysql_query($sql_cust);
			$row_cust = mysql_fetch_assoc($result_cust);

			// generate their VIP number
			if ($row_cust["Status"] != 'VIP') {
				$vipnumber = substr($row_cust["LastName"], 0, 4).substr($row_cust["BillingZip"], 0, 5)."-".substr($row_cust["Telephone"], -4);
				$todayDate = date("Y-m-d");
				$exDate = date("Y-m-d", strtotime('+1 year', strtotime($todayDate)));
				$sql_setvip = "UPDATE customers SET Status='VIP', VIPNum='$vipnumber', AccountNumber='$vipnumber', VIPLevel='1', VIPDate=current_date, VIPExpDate='$exDate' WHERE EmailAddress='$_SESSION[email]'";
				// echo "SQL: " . $sql_setvip . "<br />"; exit; // testing only
				mysql_query($sql_setvip) or die("VIP Creation Error: " . mysql_error());
				$sql_vipemail = "SELECT EmailAddress FROM emails WHERE `Type`='customerservice' LIMIT 1";
				$result_vipemail = mysql_query($sql_vipemail);
				$row_vipemail = mysql_fetch_assoc($result_vipemail);
				$vipheaders  = "From: $row_vipemail[EmailAddress]\r\n"; 
				$vipheaders .= "Content-type: text/html\r\n"; 
				$vipsubject = "SoccerOne VIP Confirmation";
				$sql_vipmess = "SELECT Message FROM messages WHERE `Type`='newvipwelcome' LIMIT 1";
				$result_vipmess = mysql_query($sql_vipmess);
				$row_vipmess = mysql_fetch_assoc($result_vipmess);
				mail($_SESSION["email"], $vipsubject, $row_vipmess["Message"], $vipheaders);
			}
		}

		$_SESSION["orderid"] = $orderid;
		$sql_from = "SELECT EmailAddress FROM emails WHERE `Type`='salesorder' LIMIT 1";
		$result_from = mysql_query($sql_from);
		$row_from = mysql_fetch_assoc($result_from);
		
		// send order confirmation email
		$sql_message = "SELECT Message FROM messages WHERE `Type`='neworderconfirmation' LIMIT 1";
		$result_message = mysql_query($sql_message);
		$row_message = mysql_fetch_assoc($result_message);
		$ordermess = str_replace("{{ORDERNUMBER}}", $orderid, $row_message["Message"]);
        
		// send VIP information email
		$sql_vipnumber = "SELECT Status, VIPNum, VIPDate, VIPLevel FROM customers WHERE EmailAddress='".$_SESSION['email']."' LIMIT 1";
		$result_vipnumber = mysql_query($sql_vipnumber);
		$row_vipnumber = @mysql_fetch_assoc($result_vipnumber);
		$cusvipnumber = isset($row_vipnumber["VIPNum"]) ? 'VIP Member: '.$row_vipnumber["VIPNum"]: '';
		$ordermess = str_replace("{{VIPNUMBER}}", strtoupper($cusvipnumber), $ordermess);
		$headers = "MIME-Version: 1.0\r\n";
		$headers .= "From: SoccerOne Customer Service <customerservice@soccerone.com>\r\n"; 
		$headers .= "Content-type: text/html; charset: utf8\r\n"; 
		$headers .= "Reply-To: SoccerOne <customerservice@soccerone.com>\r\n";
		$headers .= "X-Mailer: PHP/" . phpversion() . "\r\n";
		$subject = "SoccerOne Order Confirmation #" . $_SESSION["orderid"];
		$toCS = "customerservice@soccerone.com";
		$s1msg = "A new customer order has been received on the website from " . $customerName . " (" .$_SESSION['email'].").<br><br>------------------------------<br>";
		if ($notes) {
			$s1msg .= "<u>ORDER NOTES</u><br>" . $notes . "<br><br>";
		}
		$s1msg .= "<u>ORDERED ITEMS</u><br>";
		$sqlitems = "SELECT * FROM orders_items WHERE OrderID=".$_SESSION["orderid"]." AND Type!='CouponUsed'";
		$resultitems = mysql_query($sqlitems);
		$gc = "no";
		while ($rowitems = mysql_fetch_array($resultitems)) {
			$prodname = $rowitems["ProductName"];
			$SKU = $rowitems["RootSKU"] . "-" . $rowitems["SizeSKU"] . "-" . $rowitems["ColorSKU"];
			if ($rowitems["GenderSKU"] != NULL) {
				$SKU .= "-" . $rowitems["GenderSKU"];
			}
			$qty = $rowitems["Qty"];
			if ($rowitems["Type"] == "GC") {
				$gc = "yes";
				$gcNumber = $rowitems["ProductID"];
			} else {
				$s1msg .= $qty . " of " . $prodname . " (" . $SKU . ")<br>";
			}
		}
		$s1msg .= "------------------------------<br><br><u>ORDER INFORMATION</u><br />Order total: \$" . $ot;
		
		if (($td >= 0.01)  || ($td <= 0.01))
			$s1msg .= "<br>Discount applied: \$" . $td;
		if ($tt >= 0.01)
		    $s1msg .= "<br>Total tax: \$" . $tt;
		if ($ts >= 0.01)
		    $s1msg .= "<br>Total shipping: \$" . $ts . " via " . $ship;
	
		$s1msg .= "<br><br><u>PAYMENT INFORMATION</u>"; 
		if (($paymentMethod != "OpenAccount") && ($paymentMethod != "gcOnly")) {
			$s1msg .= "<br>" . $ct . ": " . $cardNum . "<br />CCV: " . $sc;
		} 
		if ($paymentMethod == "gcOnly") {
		    $s1msg .= "<br>Paid using Gift Certificate - (" . $gcNumber . ")";
		} 
		if (($gc == "yes") && ($paymentMethod != "gcOnly")) {
		 	$s1msg .= "<br>Paid using Gift Certificate - (" . $gcNumber . ")";
		} 
		if ($paymentMethod == "OpenAccount") {
		    $s1msg .= "<br>Paid using Open Account settings<br>";
		}
		$s1msg .= "<br><br>Please logon to the Administration Portal at your earliest convenience to see new order " . $_SESSION["orderid"] . "'s details.<br><br>The user logged in from IP Address: " . $_SERVER['REMOTE_ADDR'];
		
		$s1sub = "TESTING :: New Customer Order Received - order #" . $_SESSION["orderid"]; // testing use only
		// $s1sub = "New Customer Order Received - order #" . $_SESSION["orderid"];
			
		// email order information to customer and SoccerOne
		// mail($toCS, $s1sub, $s1msg, $headers); // send email to CS admin at SoccerOne
		mail('richard@northwind.us', $s1sub, $s1msg, $headers); // send to programmer for testing
		mail($_SESSION['email'], $subject, $ordermess, $headers, '-f customerservice@soccerone.com'); // send order email to customer
 
		// go to final order screen
		header("location:orderfinal.php");
		}
	  }
	} // end submit check
} else {
	// customer needs to login first
	header("location:myaccount.php");
}

$isvip = "no";
$pricename = "Price";

if ($submitted != 1) {
// check if qualifies for VIP pricing
if ($_SESSION["email"] != '') {
	$sql_status = "SELECT status FROM customers WHERE status='VIP' AND EmailAddress='$_SESSION[email]' AND VIPExpDate >= current_date()";
	$result_status = mysql_query($sql_status) or die("Customer Status Error: " . mysql_error());
	$status_row = mysql_fetch_array($result_status);
	$num_status = mysql_num_rows($result_status);
	if ($status_row["Status"] = '') {
		$status_update = "UPDATE customers SET status='NonMember' WHERE EmailAddress='$_SESSION[email]'";
		$update_result = mysql_query($status_update) or die("Status Update Error: " . mysql_error());
	}
	if ($num_status > 0) {
		$isvip = "yes";
		$pricename = "VIPPrice";
		$sql_remvip = "DELETE FROM shopping_cart WHERE ProductID='VIP' AND (EmailAddress='$_SESSION[email]' OR SessionID='".session_id()."')";
		mysql_query($sql_remvip);
	} 
}

// check for special gold certificate usage
$couponCk = "SELECT * FROM shopping_cart WHERE Type='Cert' LIMIT 1";
$result_couponCk = mysql_query($couponCk) or die("Certificate check error: " . mysql_error());
$num_couponCk = mysql_num_rows($result_couponCk);
if ($num_couponCk > 0) {
	$isvip = "yes";
	$pricename = "VIPPrice";
}

// give regular, nonVIP pricing
if ($isvip == "no") {
	$sql_chkcart = "SELECT * FROM shopping_cart WHERE ProductID='VIP' AND (SessionID='".session_id()."' OR EmailAddress='$_SESSION[email]')";
	$result_chkcart = mysql_query($sql_chkcart);
	$num_chkcart = mysql_num_rows($result_chkcart);
	if ($num_chkcart > 0) {
		$isvip = "yes";
		$pricename = "VIPPrice";
		// $vipShip = "yes"; // gives free shipping for VIP product
	}
}

if($_SESSION["email"] == '') {
	$sqlwhere = "SessionID='".session_id()."'";
} else {
	$sqlwhere = "(EmailAddress='$_SESSION[email]' OR SessionID='".session_id()."') ";
}

// ** SHIPPING ** 
// check for free shipping coupon
$sql_scoupon = "SELECT s.id, c.ApplyOption, c.Amount, c.ShippingOption, c.Method, c.MinimumOrder FROM shopping_cart s, coupons c WHERE s.ProductID=c.Code AND s.Type='Coupon' AND c.ApplyTo='Shipping' AND s.SessionID='".session_id()."' LIMIT 1";
$result_scoupon = mysql_query($sql_scoupon) or die("Coupon Check Error: " .mysql_error());
$row_scoupon = mysql_fetch_assoc($result_scoupon);
$freeShipItemList = array();

/** Free Shipping Check **/ 
if (!isset($row_scoupon["Method"]) || $row_scoupon["Method"] != 'free') {
	// get ups rates
	require_once("includes/upsRate.php");
	$sql_ups = "SELECT * FROM shipping WHERE `Type`='UPS' LIMIT 1";
	$result_ups = mysql_query($sql_ups) or die("UPS Error: " . mysql_error());
	$row_ups = mysql_fetch_assoc($result_ups);
	$ups_accessnumber = $row_ups["AccessKey"];
	$ups_username = $row_ups["UserName"];
	$ups_password = $row_ups["Password"];
	$ups_shippernumber = $row_ups["AccountNumber"];
	$myRate = new upsRate;
	$myRate->setCredentials($ups_accessnumber, $ups_username, $ups_password, $ups_shippernumber);
	$ship_ground = 0;
	$ship_1stDay = 0;
	$ship_2ndDay = 0;
	$ship_3Day = 0;

	// primary location zipcode
	$sql_shipfrom = "SELECT Zip FROM company LIMIT 1";
	$result_shipfrom = mysql_query($sql_shipfrom) or die("Ship From Error: " . mysql_error());
	$row_shipfrom = mysql_fetch_assoc($result_shipfrom);
	$primaryzip = $row_shipfrom["Zip"];

	// shipto zipcode
	$sql_shipto = "SELECT * FROM shopping_address WHERE SessionID='".session_id()."' LIMIT 1";
	$result_shipto = mysql_query($sql_shipto);
	$row_shipto = mysql_fetch_assoc($result_shipto);
	$shipto = $row_shipto["ShippingZip"];
	$minorder = 'yes';

	if ($row_scoupon["MinimumOrder"] > 0) {
		// calculate order total for minimum order amount
		$sql_orderTotal = "SELECT SUM($pricename * Qty) AS TotalOrder FROM shopping_cart WHERE $sqlwhere AND (`Type`='Product' OR `Type`='Bundle') AND (BundleID='' OR BundleID IS NULL)";
		$result_orderTotal = mysql_query($sql_orderTotal);
		$row_orderTotal = mysql_fetch_assoc($result_orderTotal);
		if ($row_orderTotal["TotalOrder"] < $row_scoupon["MinimumOrder"]) {
			$minorder = 'no';
		}
	}

	$freeship = 'no';
	if ($row_scoupon["ApplyOption"] == "Entire Order") {
		$freeship = 'yes';
	}

	$shipmeth = '';
	if ($row_scoupon["Method"] != '') {
		$shipmeth = $row_scoupon["Method"];
	}

	$freeshipitem = '';
	if ($row_scoupon["ApplyOption"] == "Item") {
		$freeshipitem = $row_scoupon["ShippingOption"];
	}

	$arrfreeshipcats = '';
	if ($row_scoupon["ApplyOption"] == "Category") {
		$arrfreeshipcats = str_replace("|",",", $row_scoupon["ShippingOption"]);
	}

	if ($minorder == 'no') {
		$freeship = 'no';
		$shipmeth = '';
		$freeshipitem = '';
		$arrfreeshipcats = '';
	}

	// get only products from cart
	$sql_shipitems = "SELECT ProductID, RootSKU, Qty FROM shopping_cart WHERE (SessionID='".session_id()."' OR EmailAddress='$_SESSION[email]') AND (`Type`='Product' OR `Type`='Bundle') AND (BundleID='' OR BundleID IS NULL)";
	$result_shipitems = mysql_query($sql_shipitems);

	// initial shipping variables
	$shipground_wt = 0;
	$shipground_on = 0;
	$ship1Day_wt = 0;
	$ship1Day_on = 0;
	$ship2Day_wt = 0;
	$ship2Day_on = 0;
	$ship3Day_wt = 0;
	$ship3Day_on = 0;
	$dropground_ttl = 0;
	$drop1Day_ttl = 0;
	$drop2Day_ttl = 0;
	$drop3Day_ttl = 0;
	$shipground_ttl = 0;
	$ship1Day_ttl = 0;
	$ship2Day_ttl = 0;
	$ship3Day_ttl = 0;
	$handlefee = 0;
	
	// while loop to determine shipping costs
	while ($row_shipitems = mysql_fetch_array($result_shipitems)) { 
		$sql_ship = "SELECT * FROM product_shipping WHERE ProductID=$row_shipitems[ProductID] LIMIT 1";
		$result_ship = mysql_query($sql_ship) or die("Shipping Error: " . mysql_error());
		$row_ship = array();
		if (@mysql_num_rows($result_ship)) {
			$row_ship = mysql_fetch_assoc($result_ship);
		}
		
		// elegible for free shipping?
		if ($row_ship && $row_ship["EligibleFreeShipping"] == 'yes') { 
			$efs = 'yes';
		} else { 
			$efs = 'no';
		}
		$freeshipcats = 'no';
		if ($row_scoupon["ApplyOption"] == "Category" && $arrfreeshipcats != '') {
			$sql_itemcategory = "SELECT CategoryID, ProductID FROM category_items WHERE ProductID=$row_shipitems[ProductID] AND CategoryID IN($arrfreeshipcats)";
			$result_itemcategory = mysql_query($sql_itemcategory);
			$num_itemcategory = @mysql_num_rows($result_itemcategory);
			if ($num_itemcategory > 0) {
				$freeShipItemList[$row_shipitems['ProductID']] = 1;
				$freeshipcats = 'yes';
			} else {
				$freeshipcats = 'no';
			}
		}
		if ($freeshipitem != $row_shipitems["RootSKU"] && $row_scoupon["ApplyOption"] == "Item") {
			$freeShipItemList[$row_shipitems['ProductID']] = 1;
		}
		
		// obtain shipment weight of item
		if ($row_ship["Weight"] == '') {
			$itemweight = 0;
		} else {
			$itemweight = $row_ship["Weight"];
		}
		$weight = $itemweight * $row_shipitems["Qty"];
		
		// obtain shipment ounces measurement
		if ($row_ship["Ounces"] == '') {
			$itemounces = 0;
		} else {
			$itemounces = $row_ship["Ounces"];
		}
		$ounces = $itemounces * $row_shipitems["Qty"];

		if ($row_ship["ShippingType"] == "PrimaryLocation" && $row_ship["UPS"] == "CustomerChoose") {
			if ($freeshipitem != $row_shipitems["RootSKU"] && $freeshipcats=='no' && $freeship == 'no') {
				$ship1Day_wt += $weight;
				$ship1Day_on += $ounces;
			} else {
				if ($shipmeth != '1Day' && $shipmeth != 'all') {
					$ship1Day_wt += $weight;
					$ship1Day_on += $ounces;
				} else {
					if ($efs == 'no') {
						$ship1Day_wt += $weight;
						$ship1Day_on += $ounces;
					}
				}
			}

			if ($freeshipitem != $row_shipitems["RootSKU"] && $freeshipcats=='no' && $freeship == 'no') {
				$ship2Day_wt += $weight;
				$ship2Day_on += $ounces;
			} else {
				if ($shipmeth != '2Day' && $shipmeth != 'all') {
					$ship2Day_wt += $weight;
					$ship2Day_on += $ounces;
				} else {
					if($efs == 'no') {
						$ship2Day_wt += $weight;
						$ship2Day_on += $ounces;
					}
				}
			}

			if ($freeshipitem != $row_shipitems["RootSKU"] && $freeshipcats=='no' && $freeship == 'no') {
				$ship3Day_wt += $weight;
				$ship3Day_on += $ounces;
			} else {
				if ($shipmeth != '3Day' && $shipmeth != 'all') {
					$ship3Day_wt += $weight;
					$ship3Day_on += $ounces;
				} else {
					if($efs == 'no') {
						$ship3Day_wt += $weight;
						$ship3Day_on += $ounces;
					}
				}
			}

			if ($freeshipitem != $row_shipitems["RootSKU"] && $freeshipcats=='no' && $freeship == 'no') {
				$shipground_wt += $weight;
				$shipground_on += $ounces;
			} else {
				if ($shipmeth != 'ground' && $shipmeth != 'all') {
					$shipground_wt += $weight;
					$shipground_on += $ounces;
				} else {
					if($efs == 'no') {
						$shipground_wt += $weight;
						$shipground_on += $ounces;
					}
				}
			}
			$handlefee += $row_ship["HandlingFee"];
		} elseif ($row_ship["ShippingType"] == "PrimaryLocation" && $row_ship["UPS"] == "SpecificShipping") {
			switch($row_ship["SpecificOption"]) {
				case "Ground":
					if ($freeshipitem != $row_shipitems["RootSKU"] && $freeshipcats=='no' && $freeship == 'no') {
						$shipground_wt += $weight;
						$shipground_on += $ounces;
						$shipground_temp = $shipground_temp + $weight;
					} else {
						if($shipmeth != 'ground' && $shipmeth != 'all') {
							$shipground_wt += $weight;
							$shipground_on += $ounces;
							$shipground_temp = $shipground_temp + $weight;
						} else {
							if($efs == 'no') {
								$shipground_wt += $weight;
								$shipground_on += $ounces;
								$shipground_temp = $shipground_temp + $weight;					
							}
						}
					}
					break;
				case "1stDay":
					if ($freeshipitem != $row_shipitems["RootSKU"] && $freeshipcats=='no' && $freeship == 'no') {
						$ship1Day_wt += $weight;
						$ship1Day_on += $ounces;
						$ship1Day_temp = $ship1Day_temp + $weight;
					} else {
						if($shipmeth != '1Day' && $shipmeth != 'all') {
							$ship1Day_wt += $weight;
							$ship1Day_on += $ounces;
							$ship1Day_temp = $ship1Day_temp + $weight;
						} else {
							if($efs == 'no') {
								$ship1Day_wt += $weight;
								$ship1Day_on += $ounces;
								$ship1Day_temp = $ship1Day_temp + $weight;					
							}
						}
					}
					break;
				case "2ndDay":
					if ($freeshipitem != $row_shipitems["RootSKU"] && $freeshipcats=='no' && $freeship == 'no') {
						$ship2Day_wt += $weight;
						$ship2Day_on += $ounces;
						$ship2Day_temp = $ship2Day_temp + $weight;
					} else {
						if($shipmeth != '2Day' && $shipmeth != 'all') {
							$ship2Day_wt += $weight;
							$ship2Day_on += $ounces;
							$ship2Day_temp = $ship2Day_temp + $weight;	
						} else {
							if($efs == 'no') {
								$ship2Day_wt += $weight;
								$ship2Day_on += $ounces;
								$ship2Day_temp = $ship2Day_temp + $weight;					
							}
						}
					}
					break;
				case "3Day":
					if ($freeshipitem != $row_shipitems["RootSKU"] && $freeshipcats=='no' && $freeship == 'no') {
						$ship3Day_wt += $weight;
						$ship3Day_on += $ounces;
						$ship3Day_temp = $ship3Day_temp + $weight;
					} else {
						if ($shipmeth != '3Day' && $shipmeth != 'all') {
							$ship3Day_wt += $weight;
							$ship3Day_on += $ounces;
							$ship3Day_temp = $ship3Day_temp + $weight;
						} else {
							if ($efs == 'no') {
								$ship3Day_wt += $weight;
								$ship3Day_on += $ounces;
								$ship3Day_temp = $ship3Day_temp + $weight;
							}
						}
					}
					break;
				case "Dropship":
					$dropship = 0;
					break;
			}
			$handlefee =+ $row_ship["HandlingFee"];
	
		// *** Drop Shipping *** //
		} elseif ($row_ship["ShippingType"] == "Dropship") {
			$dropweight = $weight + ($ounces / 16);
			if ($freeshipitem != $row_shipitems["RootSKU"] && $freeshipcats=='no' && $freeship == 'no') {
				$drop1Day_wt = $dropweight;
			} else {
				if ($shipmeth != '1Day' && $shipmeth != 'all') {
					$drop1Day_wt = $dropweight;
				} else {
					if ($efs == 'no') {
						$drop1Day_wt = $dropweight;
					}
				}
			}

			if ($freeshipitem != $row_shipitems["RootSKU"] && $freeshipcats=='no' && $freeship == 'no') {
				$drop2Day_wt = $dropweight;
			} else {
				if ($shipmeth != '2Day' && $shipmeth != 'all') {
					$drop2Day_wt = $dropweight;
				} else {
					if($efs == 'no') {
						$drop2Day_wt = $dropweight;
					}
				}
			}

			if ($freeshipitem != $row_shipitems["RootSKU"] && $freeshipcats=='no' && $freeship == 'no') {
				$drop3Day_wt = $dropweight;
			} else {
				if ($shipmeth != '3Day' && $shipmeth != 'all') {
					$drop3Day_wt = $dropweight;
				} else {
					if($efs == 'no') {
						$drop3Day_wt = $dropweight;
					}
				}
			}

			if ($freeshipitem != $row_shipitems["RootSKU"] && $freeshipcats=='no' && $freeship == 'no') {
				$dropground_wt = $dropweight;
			} else {
				if ($shipmeth != 'ground' && $shipmeth != 'all') {
					$dropground_wt = $dropweight;
				} else {
					if($efs == 'no') {
						$dropground_wt = $dropweight;
					}
				}
			}
			
			// CALCULATE DROPSHIP AMOUNT
			$dropVendor = 0;
			
			if ($row_ship["Length"]) {
				$DropShip_Lenght = $row_ship["Length"];
			} else {
				$DropShip_Lenght = 0;
			}
			
			if ($row_ship["Width"]) {
				$DropShip_Width = $row_ship["Width"];
			} else {
				$DropShip_Width = 0;
			}
			
			if ($row_ship["Height"]){
				$DropShip_Height = $row_ship["Height"];
			} else {
				$DropShip_Height = 0;
			}
	
			// GET VENDOR ZIPCODE	
			$DropShip_vendorid = $row_ship["DropShip"];
			$sql_vendors = "SELECT Zipcode FROM vendors WHERE id='".$DropShip_vendorid."' LIMIT 1";
			$result_vendors = mysql_query($sql_vendors);
			$row_vendors = mysql_fetch_assoc($result_vendors);
			$vendors_Zipcode = $row_vendors["Zipcode"];
			
			if ($vend != $vendors_Zipcode) {
				$vend = 0;
			}
			
			if ($vend != $vendors_Zipcode) {
				if ($dropground_wt > 0) {
					if($dropground_wt > 25) {
						$dropground_pkgs = ceil($dropground_wt / 25);
						$dropground_pkgw = $dropground_wt / $dropground_pkgs;
					} else {
						$dropground_pkgs = 1;
						$dropground_pkgw = $dropground_wt;
					}
					$dropground_rte = $myRate->getRate($vendors_Zipcode, $shipto, "03", $DropShip_Lenght, $DropShip_Width, $DropShip_Height,$dropground_pkgw);
					$dropground_ttl += ($dropground_rte * $dropground_pkgs);
				}
			
				if ($drop1Day_wt > 0) {
					if ($drop1Day_wt > 25) {
						$drop1Day_pkgs = ceil($drop1Day_wt / 25);
						$drop1Day_pkgw = $drop1Day_wt / $drop1Day_pkgs;
					} else {
						$drop1Day_pkgs = 1;
						$drop1Day_pkgw = $drop1Day_wt;
					}
					$drop1Day_rte = $myRate->getRate($vendors_Zipcode, $shipto, "01", $DropShip_Lenght, $DropShip_Width, $DropShip_Height,$drop1Day_pkgw);
					$drop1Day_ttl += ($drop1Day_rte * $drop1Day_pkgs);
				}
			
				if ($drop2Day_wt > 0) {
					if ($drop2Day_wt > 25) {
						$drop2Day_pkgs = ceil($drop2Day_wt / 25);
						$drop2Day_pkgw = $drop2Day_wt / $drop2Day_pkgs;
					} else {
						$drop2Day_pkgs = 1;
						$drop2Day_pkgw = $drop2Day_wt;
					}
					$drop2Day_rte = $myRate->getRate($vendors_Zipcode, $shipto, "02", $DropShip_Lenght, $DropShip_Width, $DropShip_Height,$drop2Day_pkgw);
					$drop2Day_ttl += ($drop2Day_rte * $drop2Day_pkgs);
				}
			
				if ($drop3Day_wt > 0) {
					if ($drop3Day_wt > 25) {
						$drop3Day_pkgs = ceil($drop3Day_wt / 25);
						$drop3Day_pkgw = $drop3Day_wt / $drop3Day_pkgs;
					} else {
						$drop3Day_pkgs = 1;
						$drop3Day_pkgw = $drop3Day_wt;
					}
					$drop3Day_rte = $myRate->getRate($vendors_Zipcode, $shipto, "12", $DropShip_Lenght, $DropShip_Width, $DropShip_Height,$drop3Day_pkgw);
					$drop3Day_ttl += ($drop3Day_rte * $drop3Day_pkgs);
				}
			
				$dropground_ttl += $row_ship["HandlingFee"];
				$drop1Day_ttl += $row_ship["HandlingFee"];
				$drop2Day_ttl += $row_ship["HandlingFee"];
				$drop3Day_ttl += $row_ship["HandlingFee"];
			}
		} // end of if/else loop
		$vend = $vendors_Zipcode;
	} //end while

	/***** CALCULATE SHIPPING ******/
	// change ounces to pounds and add to complete weight variable
	$shipground_wt += ($shipground_on / 16); 
	$ship1Day_wt += ($ship1Day_on / 16);
	$ship2Day_wt += ($ship2Day_on / 16);
	$ship3Day_wt += ($ship3Day_on / 16);
	
	
	if ($shipground_on != 0)
		$shipground_wt += 1;
	else
		$shipground_wt;
		
	if ($ship1Day_on != 0)
		$ship1Day_wt += 1;
	else
		$ship1Day_wt;
		
	if ($ship2Day_on != 0)
		$ship2Day_wt += 1;
	else
		$ship2Day_wt;
		
	if ($ship3Day_on != 0)
		$ship3Day_wt += 1;
	else
		$ship3Day_wt;
	
	if ($shipground_wt > 0) {
		if ($shipground_wt > 25) {
			$shipground_pkgs = ceil($shipground_wt / 25); // 25 pounds per package
			$shipground_pkgw = $shipground_wt / $shipground_pkgs;
		} else {
			$shipground_pkgs = 1;
			$shipground_pkgw = $shipground_wt;
		}
		$shipground_rte = $myRate->getRate($primaryzip, $shipto, "03", 0, 0, 0, $shipground_pkgw);
		$shipground_ttl = $shipground_rte * $shipground_pkgs;
	}
	
	if ($ship1Day_wt > 0) {
		if ($ship1Day_wt > 25) {
			$ship1Day_pkgs = ceil($ship1Day_wt / 25);
			$ship1Day_pkgw = $ship1Day_wt / $ship1Day_pkgs;
		} else {
			$ship1Day_pkgs = 1;
			$ship1Day_pkgw = $ship1Day_wt;
		}
		$ship1Day_rte = $myRate->getRate($primaryzip, $shipto, "01", 0, 0, 0, $ship1Day_pkgw);
		$ship1Day_ttl = $ship1Day_rte * $ship1Day_pkgs;
	}
	
	if ($ship2Day_wt > 0) {
		if ($ship2Day_wt > 25) {
			$ship2Day_pkgs = ceil($ship2Day_wt / 25);
			$ship2Day_pkgw = $ship2Day_wt / $ship2Day_pkgs;
		} else {
			$ship2Day_pkgs = 1;
			$ship2Day_pkgw = $ship2Day_wt;
		}
		$ship2Day_rte = $myRate->getRate($primaryzip, $shipto, "02", 0, 0, 0, $ship2Day_pkgw);
		$ship2Day_ttl = $ship2Day_rte * $ship2Day_pkgs;
	}
	
	if ($ship3Day_wt > 0) {
		if($ship3Day_wt > 25) {
			$ship3Day_pkgs = ceil($ship3Day_wt / 25);
			$ship3Day_pkgw = $ship3Day_wt / $ship3Day_pkgs;
		} else {
			$ship3Day_pkgs = 1;
			$ship3Day_pkgw = $ship3Day_wt;
		}
		$ship3Day_rte = $myRate->getRate($primaryzip, $shipto, "12", 0, 0, 0, $ship3Day_pkgw);
		$ship3Day_ttl = $ship3Day_rte * $ship3Day_pkgs;
	}
	/**** END CALCULATE SHIPPING ****/
	
	$ship_ground = $shipground_ttl + $dropground_ttl + $handlefee;
	$ship_1stDay = $ship1Day_ttl + $drop1Day_ttl + $handlefee;
	$ship_2ndDay = $ship2Day_ttl + $drop2Day_ttl + $handlefee;
	$ship_3Day =  $ship3Day_ttl + $drop3Day_ttl + $handlefee;
	
	// Weight calculations
	$totalWeight = 0;
	if (isset($shipground_wt)) {
    	$totalWeight += $shipground_wt;
    }
    if (isset($dropground_wt)) {
    	$totalWeight += $dropground_wt;
    }

	// testing purposes only 
	/*
	if ($row_ship["ShippingType"] == "Dropship") {
			echo "Ship from ZipCode: " . $vendors_Zipcode . "<br />Ship to ZipCode: " . $shipto . "<br />";
	} else {
		echo "Ship from ZipCode: " . $primaryzip . "<br />Ship to ZipCode: " . $shipto . "<br />";
	}
	echo "Ship Weights: " . $shipground_wt . ", " . $ship1Day_wt . ", " . $ship2Day_wt . ", " . $ship3Day_wt . "<br />";
	echo "Drop Weights: " . $dropground_wt . ", " . $drop1Day_wt . ", " . $drop2Day_wt . ", " . $drop3Day_wt . "<br />";
	echo "Packages: " . $shipground_pkgs . ", " . $ship1Day_pkgs . ", " . $ship2Day_pkgs . ", " . $ship3Day_pkgs . "<br />";
	echo "Package Weights: " . $shipground_pkgw . ", " . $ship1Day_pkgw . ", " . $ship2Day_pkgw . ", " . $ship3Day_pkgw . "<br />";
	echo "Total Weight: " . $totalWeight . "<br />";
	*/
	
	$shippingopt = '<table width="100%" border="0" cellpadding="0" cellspacing="5">';
	if ($ship_1stDay != '' || $ship_1stDay != 0) {
		$shippingopt .= "<tr><td width=\"50%\" height=\"35\" align=\"left\" valign=\"middle\" bgcolor=\"#EBEBEB\">&nbsp;<input type=\"radio\" style=\"padding: 0px 10px 0px 10px;\" class=\"optshipping required\" id=\"shipping\" name=\"shipping\" value=\"Next Day Air\" ".($shipmeth=='1Day'?'checked="true"':'')." /><span style=\"margin-top:-1px;position:absolute\">&nbsp;Next Day Air ($".number_format($ship_1stDay,2).")</span></td></tr>";
		$java .= 'case "Next Day Air": shipping='.$ship_1stDay.'; break;';
	}
	if ($ship_2ndDay != '' || $ship_2ndDay != 0) {
		$shippingopt .= "<tr><td width=\"50%\" height=\"35\" align=\"left\" valign=\"middle\" bgcolor=\"#FFFFFF\">&nbsp;<input type=\"radio\" style=\"padding: 0px 10px 0px 10px;\" class=\"optshipping required\" id=\"shipping\" name=\"shipping\" value=\"2nd Day Air\" ".($shipmeth=='2Day'?'checked="true"':'')." /><span style=\"margin-top:-1px;position:absolute\">&nbsp;2nd Day Air ($".number_format($ship_2ndDay,2).")</span></td></tr>";
		$java .= 'case "2nd Day Air": shipping='.$ship_2ndDay.'; break;';
	}
	if ($ship_3Day != '' || $ship_3Day != 0) {
		$shippingopt .= "<tr><td width=\"50%\" height=\"35\" align=\"left\" valign=\"middle\" bgcolor=\"#EBEBEB\">&nbsp;<input type=\"radio\" style=\"padding: 0px 10px 0px 10px;\" class=\"optshipping required\" id=\"shipping\" name=\"shipping\" value=\"3 Day Select\" ".($shipmeth=='3Day'?'checked="true"':'')." /><span style=\"margin-top:-1px;position:absolute\">&nbsp;3 Day Select ($".number_format($ship_3Day,2).")</span></td></tr>";
		$java .= 'case "3 Day Select": shipping='.$ship_3Day.'; break;';
	}
	if ($ship_ground != '' || $ship_ground != 0) {
		$shippingopt .= "<tr><td width=\"50%\" height=\"35\" align=\"left\" valign=\"middle\" bgcolor=\"#FFFFFF\">&nbsp;<input type=\"radio\" style=\"padding: 0px 10px 0px 10px;\" class=\"optshipping required\" id=\"shipping\" name=\"shipping\" value=\"Ground\" ".($shipmeth=='ground'?'checked="true"':'')." /><span style=\"margin-top:-1px;position:absolute\">&nbsp;Ground ($".number_format($ship_ground,2).")</span></td></tr>";
		$java .= 'case "Ground": shipping='.$ship_ground.'; break;';
	} elseif ($row_ship["ShippingType"] == "Dropship") {
		$shippingopt .= "<tr><td width=\"50%\" height=\"35\" align=\"left\" valign=\"middle\" bgcolor=\"#FFFFFF\">&nbsp;<input type=\"radio\" style=\"padding: 0px 10px 0px 10px;\" class=\"optshipping required\" id=\"shipping\" name=\"shipping\" value=\"Other\" /><span style=\"margin-top:-1px;position:absolute\">&nbsp;I have read all of the shipping messages above</span></td></tr>";
		$java .= 'case "Dropshipping": shipping=0; break;';
	}
	$shippingopt .= "</table>";
} elseif (intval($row_scoupon["MinimumOrder"]) > intval($_SESSION["orderTotal"])) {
	$shippingopt = '<table width="100%" border="0" cellpadding="0" cellspacing="5">';
	$shippingopt .= "<tr><td width=\"50%\" height=\"35\" align=\"left\" valign=\"middle\" bgcolor=\"#FFFFFF\">&nbsp;<input type=\"radio\" style=\"padding: 0px 10px 0px 10px;\" class=\"optshipping required\" id=\"shipping\" name=\"shipping\" value=\"Free\" /><span style=\"margin-top:-1px;position:absolute\">&nbsp;Free Shipping ($".number_format(0 ,2).")</span></td></tr>";
	$java .= 'case "Free Shipping": shipping=0; break;';
	$shippingopt .= "</table>";
}
if ($vipShip == "yes") {
	$shippingopt = '<table width="100%" border="0" cellpadding="0" cellspacing="5">';
	$shippingopt .= "<tr><td width=\"50%\" height=\"35\" align=\"left\" valign=\"middle\" bgcolor=\"#FFFFFF\">&nbsp;<input type=\"radio\" style=\"padding: 0px 10px 0px 10px;\" class=\"optshipping required\" id=\"shipping\" name=\"shipping\" value=\"Free\" /><span style=\"margin-top:-1px;position:absolute\">&nbsp;Free Shipping ($".number_format(0 ,2).")</span></td></tr>";
	$java .= 'case "Free Shipping": shipping=0; break;';
	$shippingopt .= "</table>";
}
// ** END SHIPPING **

// begin actual page display
$pgTitle = "Customer Order Review | SoccerOne";
include_once("includes/mainHeader.php");
?>
<script src="js/card.js"></script>
<script type="text/javascript">
$(document).ready(function() {
	$(".optshipping").click(function() {
		var shipping = 0;
		var grandtotal = 0;
		var discount = $("#totaldiscount").val();
		var tax = $("#totaltax").val();
		var ordertotal = $("#ordertotal").val();
		switch($(this).val()) {
			<?=$java;?>
		}
		grandtotal = shipping + parseFloat(tax) + parseFloat(ordertotal) + parseFloat(discount);
		if (grandtotal < 0) { 
			grandtotal = 0; 
		}
		$("#totalshippingval").html('$'+shipping.toFixed(2));
		$("#grandtotalval").html('$'+grandtotal.toFixed(2));
		$("#totalshipping").val(shipping.toFixed(2));
		$("#grandtotal").val(grandtotal.toFixed(2));
		$(".shipvia").html("This item ships: "+$(this).val());
	});

	function calCulateDefaultShipping() {
		var shipping = 0;
		var grandtotal = 0;
		var discount = $("#totaldiscount").val();
		var tax = $("#totaltax").val();
		var ordertotal = $("#ordertotal").val();
		switch($('input[name=shipping]:checked').val()) {
			<?=$java;?>
		}
		grandtotal = shipping + parseFloat(tax) + parseFloat(ordertotal) + parseFloat(discount);
		if (grandtotal < 0) { 
			grandtotal = 0; 
		}
		$("#totalshippingval").html('$'+shipping.toFixed(2));
		$("#grandtotalval").html('$'+grandtotal.toFixed(2));
		$("#totalshipping").val(shipping.toFixed(2));
		$("#grandtotal").val(grandtotal.toFixed(2));
		$(".shipvia").html("This item ships: "+$('input[name=shipping]:checked').val());
	};

	<?php if ($shipmeth != ''): ?>
	calCulateDefaultShipping();
	<?php endif; ?>

	// has the Submit Order button been clicked?
	$("#SubmitOrder").click(function() {
		// only call these functions if paying via a credit card
		/*
		if ($('#pmCreditCard:checked').attr("checked")) {
			// card validation
			 var check = checkCardNumber();
			if(check == 0) {
				$("#CardNumber").focus();
				return false;
			} 

			// expiration date validation
			 function isDigit(aChar) {
				  myCharCode = aChar.charCodeAt(0); 
				  if((myCharCode > 47) && (myCharCode <  58)) {
					 return true;
				  }			   
				  return false;
			   }

			var expdate = $("#ExpDate").val();
			if (expdate.length!=5 || expdate.charAt(2)!='/' || !isDigit(expdate.charAt(0)) || !isDigit(expdate.charAt(1)) || !isDigit(expdate.charAt(3)) || !isDigit(expdate.charAt(4))) {
				$("#ExpDate").focus();
				alert("Expiration Date is invalid");
				return false;
			}  

			var arra = expdate.split('/');			
			if (arra[0].length!=2 || arra[1].length!=2) {
				$("#ExpDate").focus();
				alert("Expiration Date is invalid");
				return false;
			} 	

			if (arra[0] < 1 || arra[0] > 12) {
				$("#ExpDate").focus();
				alert("Expiration Date is invalid");
				return false;
			} 

			var d = new Date();
			var nowmonth = d.getMonth();
			var nowYear = d.getFullYear().toString().slice(2);
			var now = parseInt(nowmonth)+parseInt(nowYear * 12) + 1;
			var expd = parseInt(arra[0])+parseInt(arra[1] * 12);  			

			if (expd <= now) {
				$("#ExpDate").focus();
				alert("Expiration Date is invalid");
				return false;
			} 
		} // end validation
		*/
		var radios = $('input[name=paymentmethod]:checked').val();
		/*
		if (radios == "CreditCard") {
			var fields = new Array("totalshipping", "CardType", "NameOnCard", "CardNumber", "ExpDate", "SecurityCode", "AccountCode");
			for (var i=0; i<fields.length; i++) {
				if ($("#"+fields[i]).val() == '') {
					if (fields[i] == "SecurityCode") {
						alert("Security Code number is invalid");
					} else if (fields[i] == "NameOnCard") {
						alert("Name on Card is invalid");
					} else {
						alert(fields[i] + " is invalid");
					}
					$("#"+fields[i]).focus();
					return false;
				}
			}
		}
		*/
				
		// check for agreement to Terms
		if ($("#agree").is(":checked")) {
		} else {
			alert('Please agree with the terms and conditions before completing the order');
			return false;
		}
			
		$("form").submit();
	}); // end submit function
	
	
	// if selected, show card entry fields	 
	$("#pmCreditCard").click(function() {
		$("#paymenttype").html('<img src="images/loader.gif" alt="Please wait...." />');
		$("#paymenttype").load("includes/inc_checkout.php", {
			"type":"card"
		});
	});
	
	// if pay on account selected, hide credit card entry details
	//$("#pmOpenAccount").click(function() {
	//	$("#paymenttype").remove().hide();
	//});
	
	
	// was the GC apply link clicked?
	$("#pmGiftCert").click(function() {
		var ts = $("#totalshipping").val();
		if (ts == "" || ts == "0") {
			alert("Please choose a shipping option!");
		} else {
			$("#gcError").load("includes/inc_gc.php", {
				"type":"apply",
				"num":$("#gcNum").val(),
				"gt":$("#grandtotal").val()
			}, function(data) {
				if (data = "success") {
					$("#gcError").text("Gift Certificate funds applied!").css("color", "red");
				    if ($("#grandtotal").val() == 0) {
				        $('#paymentDIV').html('<input type="radio" name="paymentmethod" value="gcOnly" checked="checked"> Gift Certificate funds only');
				    } 
				} else {
					$("#gcError").text("ERROR").css("color", "red");
				}
			});
		} 
	});
	
	// was the GC check balance clicked?
	$("#gcBal").click(function() {
		$("#gcError").load("includes/inc_gc.php", {
			"type":"bal",
			"num":$("#gcNum").val()
		});
	});
});
</script>
<script type="text/javascript">
function isNumberKey(evt) {
	 var charCode = (evt.which) ? evt.which : event.keyCode; 
	 if (charCode > 31 && (charCode < 48 || charCode > 57))
		return false;
	 return true;
}

function checkCardNumber() {
	var CardNumber = document.getElementById('CardNumber').value;
	var myindex = document.getElementById('CardType').selectedIndex;
	var CardType = document.getElementById('CardType').options[myindex].value; 

	if(CardNumber != '' && !isNaN(CardNumber)) {
		if(CardType == "Visa" && CardNumber.length != 16) {
			showSpan("Visa Card Number is Invalid");
			return 0;
		}

		if(CardType == "Visa" && CardNumber.charAt(0) != '4') {
			showSpan("Visa Card Number is Invalid");
			return 0;
		}

		if(CardType=="MasterCard" && CardNumber.length!=16) {
			showSpan("MasterCard Number is Invalid");
			return 0;
		}	

		if(CardType=="MasterCard" && CardNumber.charAt(0)!='5') {
			showSpan("MasterCard Number is Invalid");
			return 0;
		}

		if(CardType=="DiscoverCard" && CardNumber.length!=16) {
			showSpan("Discover Card Number is Invalid");
			return 0;
		}

		if(CardType=="DiscoverCard" && CardNumber.charAt(0)!='6') {
			showSpan("Discover Card Number is Invalid");
			return 0;
		}

		if(CardType=="American Express" && CardNumber.length!=15) {
			showSpan("American Express Card Number is Invalid");
			return 0;
		}

		if(CardType=="American Express" && CardNumber.charAt(0)!='3') { 
			showSpan("American Express Card Number is Invalid");
			return 0;
		}
	} else {
		if(CardType=="Visa") {
			showSpan("Visa Card Number is Invalid");
			return 0;
		} else if(CardType=="MasterCard"  ) {
			showSpan("MasterCard  Number is Invalid");
			return 0;
		} else if(CardType=="DiscoverCard" ) {
			showSpan("Discover Card Number is Invalid");
			return 0;
		} else if(CardType=="American Express" ) { 
			showSpan("American Express Card Number is Invalid");
			return 0;
		}
	}

	function showSpan(str) {	
		alert(str);
	}

 return 1;
} 
</script> 
<style type="text/css">
.style1 { color: #FFFFFF; }
.style2 { font-size: 0.875em; }
.style3 { font-size: 0.875em; }
.style4 { 
	font-size: 0.875em; 
	color: #FFFFFF; 
}
</style>
</head>
<body>
<div class="Master_div"><?php include_once('includes/header.php'); ?>
  <div class="container container1">
    <div class="navigation">
      <div class="navi_L"></div>
      <div class="navi_C"><?php include_once('includes/topnav.php'); ?>
        <div class="clear"></div>
      </div>
      <div class="navi_R"></div>
      <div class="clear"></div>
    </div>
	<div class="clear"></div>
	<div class="main">
<?php
	// get all products from Shopping Cart
	$sql_cart = "SELECT * FROM shopping_cart WHERE $sqlwhere AND (`Type`='Product' OR `Type`='Bundle' OR `Type`='VIP') AND (BundleID='' OR BundleID IS NULL)";
	$ordertotal = 0;
	$availablediscount = 0;
	$taxableamount = 0;
	$customVipPrice = 0;
	$orderTotalWithoutSpePrice = 0;
	$couponCalc = new CouponCalculation(0, 0, $isvip);
	$result_cart = mysql_query($sql_cart) or die("Shopping Cart Error: " . mysql_error());
	
	// process the Shopping Cart products
	if (@mysql_num_rows($result_cart)) {
?>
	<script type="text/javascript" src="/js/jquery.validate.min.js"></script>
	<style type="text/css">
		label { 
			width: 10em; 
			float: left; 
		}
		label.error { 
			padding: 10px 10px 10px 10px;
			margin: 10px 0;
			border: solid 1px; 
			border-color: #DF8F8F;
			background-color: #FFDCDC;
			font-size: 1em;
		}
		p { 
			clear: both; 
		}
		.submit { 
			margin-left: 12em; 
		}
		em { 
			font-weight: bold; 
			padding-right: 1em; 
			vertical-align: top; 
		}
	</style>
	<script type="text/javascript">
  	$(document).ready(function() {
    	$("#orderForm").validate({
    		rules: {
    			CardNumber: {
    				creditcard: true
    			}
    		}
    	});
  	});
  	</script>
	<form action="" method="post" id="orderForm" name="orderForm">
	<table width="960" border="0" align="center" cellpadding="3" cellspacing="0" style="margin-top:15px;margin-left:8px">
	<tr>
		<td style="background-color:#FF0000;color:#fff;border:none;height:35px;width:100px">&nbsp;</td>
		<td style="width: 200px;background-color:#FF0000;color:#fff;border:none;height:35px;font-size:0.875em">Product Name</td>
		<td style="width: 150px;background-color:#FF0000;color:#fff;border:none;height:35px;font-size:0.875em">SKU</td>
		<td style="background-color:#FF0000;color:#fff;border:none;height:35px;font-size:0.875em">Non Member Price</td>
	<?php 
		if ($isvip == "yes") { 
			echo '<td style="background-color:#FF0000;color:#fff;border:none;height:35px;font-size:0.875em">VIP Price</td>';
		} 
	?>
		<td style="background-color:#FF0000;color:#fff;border:none;height:35px;font-size:0.875em">QTY</td>
		<td style="background-color:#FF0000;color:#fff;border:none;height:35px;font-size:0.875em">Subtotal</td>
	</tr>
<?php
	while ($row_cart = mysql_fetch_array($result_cart)) {
		$cusTotalProduct++;
			if ($row_cart["Type"] != "VIP") {
				$sql_shiptype = "SELECT * FROM product_shipping WHERE ProductID=$row_cart[ProductID] LIMIT 1";
				$result_shiptype = mysql_query($sql_shiptype) or die("ShipType Error: " . mysql_error());
				$row_shiptype = array();
				if (@mysql_num_rows($result_shiptype)) {
					$row_shiptype = mysql_fetch_assoc($result_shiptype);
				}
				if ($row_shiptype && $row_shiptype["ShippingType"] == "PrimaryLocation" && $row_shiptype["UPS"] == "SpecificShipping") {
					$shipmess = "This item ships: ".$row_shiptype["SpecificOption"];
				} elseif($row_shiptype["ShippingType"] == 'Dropship') {
					$shipmess = "This item will ship from another location";
				} else {
					$shipmess = '<span class="shipvia"></span>';
				}

				if ($row_cart["ColorSKU"] == '') {
					$imgColorSKU = "IS NULL ";
				} else {
					$imgColorSKU = "='$row_cart[ColorSKU]' ";
				}

				if ($row_cart["SizeSKU"] == '') {
					$imgSizeSKU = "IS NULL ";
				} else {
					$imgSizeSKU = "='$row_cart[SizeSKU]' ";
				}
			
				// obtain main product image
				if ($imgColorSKU != "IS NULL ") {
					$sql_image = "SELECT ColorImage FROM product_options WHERE ProductID=$row_cart[ProductID] AND ColorSKU $imgColorSKU AND SizeSKU $imgSizeSKU LIMIT 1";
				} else {
					$sql_image = "SELECT ColorImage FROM product_options WHERE ProductID=$row_cart[ProductID] LIMIT 1";
				}
				// echo "SQL: " . $sql_image; exit; // testing
				$result_image = mysql_query($sql_image) or die("Image Error: " . mysql_error());
				$row_image = array();
				if (@mysql_num_rows($result_image)) {
					$row_image = mysql_fetch_assoc($result_image);
				}
					
				// create final product order complete SKU
				$sql_skuorder = "SELECT SKUOrder FROM products WHERE id=$row_cart[ProductID] LIMIT 1";
				$result_skuorder = mysql_query($sql_skuorder);
					
				// get rootsku
				if (@mysql_num_rows($result_skuorder)) {
					$row_skuorder = mysql_fetch_assoc($result_skuorder);
					$skuorder = explode("|", $row_skuorder["SKUOrder"]);
					$prodsku = $row_cart[$skuorder[0]."SKU"];

					if ($row_cart[$skuorder[1]."SKU"] != '') {
						$prodsku .= "-".$row_cart[$skuorder[1]."SKU"];
					}

					if ($row_cart[$skuorder[2]."SKU"] != '') {
						$prodsku .= "-".$row_cart[$skuorder[2]."SKU"];
					}
				}

				if ($row_cart["GenderSKU"] != '') {
					$prodsku .= "-".$row_cart["GenderSKU"];
				}
				
		/*
			$productCalcPrice = getVipPrice($row_cart["GenderSKU"], $row_cart['ColorSKU'], $row_cart['SizeSKU'], $row_cart['ProductID'], $row_cart["Qty"]);
			$pro_NoneMemberPrice = $productCalcPrice['NoneMemberPrice'];
			if ($isvip == "yes") {
				$productCalcPrice['VIPPrice'] = $row_cart[$pricename];
			}
		
			// check for 'special' pricing
			$sql_special_price = "SELECT SpecialPrice, isSpecial FROM products WHERE id =".$row_cart["ProductID"]." AND ((DATE_FORMAT(SpecialFrom, '%Y-%m-%d') <= DATE_FORMAT(current_date, '%Y-%m-%d')  OR SpecialFrom='') AND (DATE_FORMAT(current_date, '%Y-%m-%d') <= DATE_FORMAT(SpecialTo, '%Y-%m-%d') OR SpecialTo='')) AND isSpecial!='' LIMIT 1";
			$result_special_price = mysql_query($sql_special_price);
		  	$row_special_price = @mysql_fetch_array($result_special_price);
	    	if (isset($row_special_price['isSpecial']) && $row_special_price['isSpecial'] == "True") {
	    		$specialPrice = number_format($row_special_price['SpecialPrice'], 2);
				$pro_NoneMemberPrice = $specialPrice;
				$row_cart[$pricename] = $specialPrice;
			} else {
				$availablediscount = $availablediscount+$total;
				$orderTotalWithoutSpePrice += $row_cart["Qty"]*$row_cart[$pricename];
			}

			// update pricing in db according to VIP status
			if ($isvip == "yes") {
				$updateShoppingCartVip = "UPDATE shopping_cart SET Price='".$pro_NoneMemberPrice."',  VIPPrice='".$row_cart[$pricename]."' WHERE id=".$row_cart["id"];
				mysql_query($updateShoppingCartVip);
			} else {
				$updateShoppingCartVip = "UPDATE shopping_cart SET Price='".$pro_NoneMemberPrice."', VIPPrice='0' WHERE id=".$row_cart["id"];
				mysql_query($updateShoppingCartVip);
			}
		*/

			$total = $row_cart["Qty"] * $row_cart[$pricename];
			$ordertotal = $ordertotal + $total;

			/** Tax Calculation **/
			// if ($row_cart["Type"] != "VIP") {
				$sql_prodtax = "SELECT Taxable FROM products WHERE id=$row_cart[ProductID] LIMIT 1";
				$result_prodtax = mysql_query($sql_prodtax) or die("Tax Error: " . mysql_error());
				if (@mysql_num_rows($result_prodtax)) {
					$row_prodtax = mysql_fetch_assoc($result_prodtax);
					if ($row_prodtax["Taxable"] == 'Yes') {
						$taxableamount = $taxableamount + ($row_cart[$pricename] * $row_cart["Qty"]);
					}
				}
			// }
	?>
			<tr>
	<?php 
			$isConfirmProduct = false;
			if ($row_image) { 
				$isConfirmProduct = false;
				// show VIP membership image if that is the product
				if ($row_cart["Type"] == "VIP") {
					echo '<td class="cartitem"><img class="cartthumb" src="cpadmin/images/productImages/' . $row_vipd["Image"] . '" /></td>';
				// otherwise show the main image for the product
				} else {
					echo '<td class="cartitem"><img class="cartthumb" src="cpadmin/images/productImages/' . $row_image["ColorImage"] . '" /></td>';
				} 
			}
			// no image to show? make blank table cell
			if ($row_image == '' or $row_image == NULL) { 
				echo '<td class="cartitem"></td>';
			} 
	?>
	<?php 
			if (!$isConfirmProduct) { 
	 			echo '<td class="cartitem">' . $row_cart["ProductName"];
    			if (array_key_exists($row_cart['ProductID'], $freeShipItemList)) {
    				echo '<br/><span style="font-size: 11px;">This item ships: Free shipping</span>';
    			} else {
    				if ($shipmess != '') {
                		echo '<br/><span style="font-size: 11px;">' . $shipmess . '</span>';
    				}
    			}
    			echo '</td>';
                echo '<td class="cartitem">'. $prodsku .'</td>';
			}
	?>
				<td class="cartitem">
	<?php 
		if ($isvip == "yes") {
			echo '<span style="color: #909090;text-decoration:line-through;">$' . number_format($row_cart["Price"], 2) . '</span>';
		} else {
			echo "$" . number_format($row_cart[$pricename], 2);
		}
	?>
				</td>
	<?php 
		if ($isvip == "yes") { 
			echo '<td class="cartitem">$'. number_format($row_cart[$pricename], 2) . '</td>';
		} 
	?>
				<td class="cartitem"><?=$row_cart["Qty"];?></td>
				<td class="cartitem">$<?=number_format($total, 2);?></td>
			</tr>
    <?php
			// if ($row_cart["Type"] != "VIP") {
				$sql_ship1 = "SELECT * FROM product_shipping WHERE ProductID=$row_cart[ProductID] LIMIT 1";
				$result_ship1 = mysql_query($sql_ship1) or die("Shipping error: " . mysql_error());
				$mysql_fetch1 = mysql_fetch_array($result_ship1);
				if (isset($mysql_fetch1['Description'])) {
					echo '<tr><td bgcolor="#EBEBEB" height="35" colspan="7"><div style="width:100%; text-align:left; float:left;">' . $mysql_fetch1['Description'] . '</div></td></tr>';
				}
			// }
			
			if ($row_cart["Type"] == "Bundle") {
				$sql_bitems = "SELECT * FROM shopping_cart WHERE $sqlwhere AND BundleID=$row_cart[id] ORDER BY ProductName";
				$result_bitems = mysql_query($sql_bitems) or die("Bundle Error: " . mysql_error());
				while ($row_bitems = mysql_fetch_array($result_bitems)) {
					$sql_bimage = "SELECT ColorImage FROM product_options WHERE ProductID=$row_bitems[ProductID] AND ColorSKU='$row_bitems[ColorSKU]' AND SizeSKU='$row_bitems[SizeSKU]' LIMIT 1";
					$result_bimage = mysql_query($sql_bimage) or die("Bundle Image Error: " . mysql_error());
					$row_bimage = mysql_fetch_assoc($result_bimage);
	?>
			<tr>
				<td class="cartitem"></td>
				<td class="cartitem"><img class="cartthumb" style="width: 27px; float: left;" src="cpadmin/images/productImages/<?=$row_bimage["ColorImage"];?>" /><?=$row_bitems["ProductName"];?></td>
				<td class="cartitem"><?=$row_bitems["RootSKU"]."-".$row_bitems["ColorSKU"]."-".$row_bitems["SizeSKU"]." x ".$row_bitems["Qty"];?></td>
				<td class="cartitem"></td>
	<?php 
		if ($isvip == "yes") { 
			echo '<td class="cartitem"></td>';
		}
	?>
				<td class="cartitem"></td>
				<td class="cartitem"></td>
			</tr>    
	<?php
			$sql_ship2 = "SELECT * FROM product_shipping WHERE ProductID=$row_bitems[ProductID] LIMIT 1";
			$result_ship2 = mysql_query($sql_ship2) or die("Bundle Shipping Error: " . mysql_error());
			$mysql_fetch2 = mysql_fetch_array($result_ship2);
	?>       
			<tr>
			   	<td bgcolor="#EBEBEB" height="35" colspan="7"><div style="width:100%; text-align:left; float:left;"><?php echo $mysql_fetch1['Description'];?></div></div></td>
		  	</tr>
	<?php
				} // end while bundle
			} else {
				$sql_bitems = "SELECT * FROM shopping_cart_single WHERE ".$sqlwhere." AND singleid=".$row_cart['id']." ORDER BY ProductName";
				$result_bitems = mysql_query($sql_bitems) or die("Single Item Error: " . mysql_error());
				while ($row_bitems = mysql_fetch_array($result_bitems)) {
					$sql_bimage = "SELECT ColorImage FROM product_options WHERE ProductID=".$row_bitems['ProductID']." AND ColorSKU='".$row_bitems['ColorSKU']."' AND SizeSKU='".$row_bitems['SizeSKU']."' LIMIT 1";
					$result_bimage = mysql_query($sql_bimage) or die("Image Error: " . mysql_error());
					$row_bimage = mysql_fetch_assoc($result_bimage);
	?>
			<tr>
				<td class="cartitem"></td>
				<td class="cartitem"><img class="cartthumb" style="width: 27px; float: left;" src="cpadmin/images/productImages/<?=$row_bimage["ColorImage"];?>" /><?=$row_bitems["ProductName"];?></td>
				<td class="cartitem"><?=$row_bitems["RootSKU"]."-".$row_bitems["ColorSKU"]."-".$row_bitems["SizeSKU"]." x ".$row_bitems["Qty"];?></td>
				<td class="cartitem"></td>
	<?php 
		if ($isvip == "yes") {
			echo '<td class="cartitem"></td>';
		}
	?>
				<td class="cartitem"></td>
				<td class="cartitem"></td>
			</tr>
    <?php
				$sql_ship2 = "SELECT * FROM product_shipping WHERE ProductID=$row_bitems[ProductID] LIMIT 1";
				$result_ship2 = mysql_query($sql_ship2);
				$mysql_fetch2 = mysql_fetch_array($result_ship2);
			} // end while
		} // end bundle if
			
			// IMPRINT INFORMATION 
			$sql_imp = "SELECT * FROM imprint_shopping_cart WHERE $sqlwhere AND ProductID='$row_cart[ProductID]'";
			$result_imp = mysql_query($sql_imp);
			$num_imp = mysql_num_rows($result_imp);
			$impPrice = 0;
			if ($num_imp > 0) {
				$imprint_data = '<table class="imprintOptions" cellpadding="3" cellspacing="0"><tr><td class="impheader" colspan="3">Imprint Options</td><td class="impheader"></td></tr>';
				while ($row_imp = mysql_fetch_array($result_imp)) {
					$impPrice += floatval($row_imp["ImprintPrice"]);
					$optName = ucfirst($row_imp["Opt1Type"]);
					if ($row_imp["Opt2Type"] != "") {
						$optName .= " & ".ucfirst($row_imp["Opt2Type"]);
					}
					$optTeam = '';
					switch ($row_imp["Opt1Type"]) {
						case "chestlogo":
							$optType1 = "Chest Logo";
							$optTeam = stripslashes($row_imp["Opt1Team"]);
							break;
						case "pocketlogo":
							$optType1 = "Pocket Logo";
							$optTeam = stripslashes($row_imp["Opt1Team"]);
							break;
						default:
							$optType1 = ucfirst($row_imp["Opt1Type"]);
					}	
					$imprint_data .= '<tr><td class="impLocation">'.$row_imp["Opt1Loc"].'</td><td class="impType">'.$optType1;
								
					if ($optTeam != '') {
						$imprint_data .= " (Team: ".$optTeam.")";
					}
								
					if ($row_imp["Opt1Color"] != '') {
						$imprint_data .= " (Color: ".$row_imp["Opt1Color"].")";
					}
								
					if ($row_imp["Opt1Text"] != '') {
						$imprint_data .= ':<br/>'.str_replace("|","<br/>",$row_imp["Opt1Text"]).' ';
					}
					
					if ($row_imp["Opt2Type"] != '') {
						$optTeam = '';
						switch ($row_imp["Opt2Type"]) {
							case "chestlogo":
								$optType2 = "Chest Logo";
								$optTeam = stripslashes($row_imp["Opt2Team"]);
								break;
							case "pocketlogo":
								$optType2 = "Pocket Logo";
								$optTeam = stripslashes($row_imp["Opt2Team"]);
								break;
							default:
								$optType2 = ucfirst($row_imp["Opt2Type"]);
						}
						$imprint_data .= '<br/>'.$optType2;		
						if ($optTeam != '') {
							$imprint_data .= " (Team: ".$optTeam.")";
						}
									
						if ($row_imp["Opt2Color"] != '') {
							$imprint_data .= " (Color: ".$row_imp["Opt2Color"].") ";
						}									
					}
								
					if ($row_imp["Opt2Text"] != '') {
						$imprint_data .= ':<br/>'.str_replace("|","<br/>",$row_imp["Opt2Text"]).' ';
					}
								
					$imprint_data .= '</td><td class="impPrice">$'.number_format($row_imp["ImprintPrice"],2).'</td><td class="impImage">';
					if ($row_imp["Opt1Image"] != '') {
						$imprint_data .= '<img src="'.$row_imp["Opt1Image"].'" alt="'.$row_imp["Opt1Type"].'" title="'.$row_imp["Opt1Loc"]." - ".$row_imp["Opt1Type"].'" />';
					}
								
					if ($row_imp["Opt2Image"] != '') {
						$imprint_data .= '&nbsp; <img src="'.$row_imp["Opt2Image"].'" alt="'.$row_imp["Opt2Type"].'" title="'.$row_imp["Opt2Loc"]." - ".$row_imp["Opt2Type"].'" />';
					}
								
					$imprint_data .= '</td></tr>';
				} // end while
				$imprint_data .= '<tr><td class="noBtmBdr"></td><td class="noBtmBdr right">Imprint Total:</td><td class="noBtmBdr">$'.number_format($impPrice, 2).'</td><td class="noBtmBdr"></td></tr></table>';
		?>
			<tr>
				<td colspan="7"><?=$imprint_data;?></td>
			</tr>
		<?php
				$ordertotal = $ordertotal + $impPrice;
			} else {
				$imprint_data = "";
			}
			// END IMPRINT INFORMATION

			$freeitemHtml = $couponCalc->getSkuFreeItem(false, $shipmess, $row_cart['RootSKU'], 0, $row_cart["Qty"]);
			foreach ($freeitemHtml as $html) { 
				echo $html[0];
			}
		} // end row_image if loop
	} // end main while loop
	
	// get coupon/discount information
	$discount = $_SESSION['discount'];
	/*
	$sql_cart2 = "SELECT * FROM shopping_cart WHERE $sqlwhere AND `Type`='Coupon' AND (BundleID='' OR BundleID IS NULL)";
	$result2 = mysql_query($sql_cart2) or die("Coupon Error: " . mysql_error());
	$row_cart2 = mysql_fetch_array($result2);
	if ($row_cart2["Price"] != '') {
		$discount -= $row_cart2["Price"];
	} else {
		$discount += 0;
	}
    */
	// add coupon info to the cart listing	
	$sql_cp1 = "SELECT * FROM shopping_cart WHERE $sqlwhere AND `Type`='Coupon'";
	$result_cp1 = mysql_query($sql_cp1);
	while($row_cp1 = mysql_fetch_array($result_cp1)) {
	?>
	<tr>
        <td class="cartitem">&nbsp;</td>
		<td class="cartitem"><?php echo $row_cp1["ProductName"];?></td>
		<td class="cartitem"><?php echo $row_cp1["ProductID"];?></td>
		<td class="cartitem">-</td>
	<?php if ($isvip == "yes") : ?>
		<td class="cartitem">-</td>
	<?php endif; ?>
		<td class="cartitem">1</td>
		<td class="cartitem">
	<?php 
	    $sql_cp = "SELECT * FROM coupons WHERE Code='" . $row_cp1["ProductID"] . "'";
	    // echo "DEBUG: " . $sql_cp; exit(); // testing only
	    $resultcp = mysql_query($sql_cp) or die("Coupon Retrieval Error: " . mysql_error());
	    $row_cp = mysql_fetch_array($resultcp);
	    if ($row_cp["Type"] == "dollar") {
	        echo "$" . number_format($row_cp1["Price"], 2);
	        echo "</td>";
	    } else {
            echo $row_cp1["Price"] . "%";
            echo "</td>";
        }
	?>
    </tr>
	<?php
	}
	
	// add Certificate info to the Cart
		$sql_cp = "SELECT * FROM shopping_cart WHERE $sqlwhere AND `Type`='Cert'";
		$result_cp = mysql_query($sql_cp);
		while($row_cp = mysql_fetch_array($result_cp)) {
		?>
		<tr>
            <td class="cartitem">&nbsp;</td>
			<td class="cartitem"><?php echo $row_cp["ProductName"];?></td>
			<td class="cartitem"><?php echo $row_cp["ProductID"];?></td>
			<td class="cartitem">-</td>
		<?php if ($isvip == "yes") : ?>
			<td class="cartitem">-</td>
		<?php endif; ?>
			<td class="cartitem">1</td>
			<td class="cartitem">$<?php echo number_format($row_cp["Price"], 2); ?></td>
        </tr>
		<?php
		}
		
		// add GC info to the Cart
		/* 
		$sql_cp2 = "SELECT * FROM shopping_cart WHERE $sqlwhere AND `Type`='GC'";
		$result_cp2 = mysql_query($sql_cp2);
		while($row_cp2 = mysql_fetch_array($result_cp2)) {
		?>
		<tr>
            <td class="cartitem">&nbsp;</td>
			<td class="cartitem"><?php echo $row_cp2["ProductName"];?></td>
			<td class="cartitem"><?php echo $row_cp2["ProductID"];?></td>
			<td class="cartitem">-</td>
		<?php if ($isvip == "yes") : ?>
			<td class="cartitem">-</td>
		<?php endif; ?>
			<td class="cartitem">1</td>
			<td class="cartitem">$<?php echo number_format($row_cp2["Price"], 2); ?></td>
        </tr>
        <input type="hidden" name="GC" value="1">
        <input type="hidden" name="gcNum" value="<?=$row_cp2['ProductID'];?>">
        <input type="hidden" name="balance" value="<?=$row_cp2['Price'];?>">
		<?php
			$discount += $row_cp2["Price"];
		}
		*/
		
		// add VIP memberhsip to cart 
		$sql_vip = "SELECT * FROM shopping_cart WHERE $sqlwhere AND `Type`='VIP'";
		$result_vip = mysql_query($sql_vip) or die("VIP Cart Error: " . mysql_error());
		while ($row_vip = mysql_fetch_array($result_vip)) {
			$sql_vipd = "SELECT Image FROM vip LIMIT 1";
			$result_vipd = mysql_query($sql_vipd);
			$row_vipd = mysql_fetch_assoc($result_vipd);
	?>
		<tr>
            <td class="cartitem"><img class="cartthumb" src="cpadmin/images/productImages/<?=$row_vipd["Image"];?>" /></td>
			<td class="cartitem"><?=$row_vip["ProductName"];?></td>
			<td class="cartitem"><?=$row_vip["ProductID"];?></td>
			<td class="cartitem">-</td>
	<?php 
		if ($isvip=="yes") { ?>
			<td class="cartitem"></td>
	<?php 
		} 
	?>
			<td class="cartitem">1</td>
			<td class="cartitem">$<?=number_format($row_vip["Price"],2);?></td>
        </tr>
    <?php
			$ordertotal = $ordertotal + $row_vip["Price"];
		}
		
		$sql_shipst = "SELECT ShippingState FROM shopping_address WHERE SessionID='".session_id()."' LIMIT 1";
		$result_shipst = mysql_query($sql_shipst);
		$row_shipst = mysql_fetch_assoc($result_shipst);
		$sql_tax = "SELECT Tax FROM taxes WHERE State='$row_shipst[ShippingState]' LIMIT 1";
		$result_tax = mysql_query($sql_tax);
		$row_tax = mysql_fetch_assoc($result_tax);
		$totaltax = $taxableamount * ($row_tax["Tax"] / 100);
		$grandtotal = $totaltax + ($ordertotal + $discount);
		if ($grandtotal < 0) {
			$grandtotal = 0;
		}
	?>
		</table>
		<input type="hidden" id="ordertotal" name="ordertotal" value="<?=$ordertotal;?>" />
		<input type="hidden" id="totaltax" name="totaltax" value="<?=$totaltax;?>" />
		<input type="hidden" id="totaldiscount" name="totaldiscount" value="<?=$discount;?>" />
		<input type="hidden" id="grandtotal" name="grandtotal" value="<?=$grandtotal;?>" />
  		<input type="hidden" id="totalshipping" name="totalshipping" value="" />
        <input type="hidden" id="isvip" name="isvip" value="<?=$isvip;?>" />
    <?php
        if (isset($totalWeight)) {
        	echo '<input type="hidden" id="weight" name="Weight" value="' . $totalWeight . '" />';
        } else {
        	echo '<input type="hidden" id="weight" name="Weight" value="0" />';
        }
    ?>
		<table width="960" border="0" align="center" cellpadding="3" cellspacing="0" style="margin-left:8px">
		<tr>
			<td width="100%" height="35" bgcolor="#FF0000" colspan="2"><span class="style1">Shipping Options</span></td>
		</tr>
		<tr>
			<td width="37%" height="35" align="left" valign="top" bgcolor="#FFFFFF"><?=$shippingopt;?></td>
			<td width="63%" height="35" align="right" valign="top" bgcolor="#FFFFFF">
			<table width="400" border="0" cellpadding="0" cellspacing="5">
			<tr>
			    <td width="50%" height="35" align="left" valign="middle">&nbsp;<span class="style3">Order Total</span></td>
				<td width="50%" align="left" valign="middle">&nbsp;<span id="ordertotalval">$<?=number_format($ordertotal, 2);?></span></td>
			</tr>
			<tr>
				<td width="50%" height="35" align="left" valign="middle" bgcolor="#EBEBEB">&nbsp;<span class="style3">Tax<input type="hidden" id="tax" name="tax" value="<?=$row_tax["Tax"];?>" /></span></td>
				<td width="50%" align="left" valign="middle" bgcolor="#EBEBEB">&nbsp;<span id="totaltaxval">$<?=number_format($totaltax, 2);?></span></td>
			</tr>
			<tr>
				<td width="50%" height="35" align="left" valign="middle" bgcolor="#FFFFFF">&nbsp;<span class="style3">Discount</span></td>
 				<td width="50%" align="left" valign="middle" bgcolor="#FFFFFF">&nbsp;<span id="totaldiscountval">$<?=number_format($discount, 2);?></span></td>
			</tr>
			<tr>
				<td width="50%" height="35" align="left" valign="middle"  bgcolor="#EBEBEB">&nbsp;<span class="style3">Shipping</span></td>
				<td width="50%" align="left" valign="middle" bgcolor="#EBEBEB">&nbsp;<span id="totalshippingval">$0.00</span></td>
			</tr>
			<tr>
				<td height="35" align="left" valign="middle" bgcolor="#FFFFFF">&nbsp;<span class="style3">Grand Total</span></td>
				<td align="left" valign="middle" bgcolor="#FFFFFF">&nbsp;<span id="grandtotalval">$<?=number_format($grandtotal,2);?></span></td>
			</tr>
			</table></td>
		</tr>
		</table>
		<table width="960" border="0" align="center" cellpadding="5" cellspacing="5" style="margin-left:8px">
		<tr>
			<td width="50%" height="35" align="left" bgcolor="#FF0000"><span class="style1"> Payment Information:</span></td>
			<td width="50%" height="35" align="left" bgcolor="#FF0000"><span class="style1"> Gift Certificate:</span></td>
		</tr>
		<tr>
			<td bgcolor="#FFFFFF"><div id="paymentDIV"><?php
				$sql_chkcredit = "SELECT CreditLine, AccountNumber FROM customers WHERE EmailAddress='$_SESSION[email]' LIMIT 1";
				$result_chkcredit = mysql_query($sql_chkcredit);
				$row_chkcredit = mysql_fetch_assoc($result_chkcredit);
				if ($row_chkcredit["CreditLine"] == '1') {
					echo '<input type="radio" id="pmOpenAccount" name="paymentmethod" style="font-size:0.875em;" class="required" value="OpenAccount" />&nbsp;Pay with Open Account <small>#' . $row_chkcredit['AccountNumber'] . '</small><br>'; 
				}
			?>
			<input type="radio" id="pmCreditCard" name="paymentmethod" class="required" style="padding: 5px 0px;font-size:0.875em;" value="CreditCard" />&nbsp;Pay with Credit / Debit card</div></td>
			<td valign="top" width="30%"><table><tr><td><img src="images/gift_cert.jpg" width="75"></td><td><div id="gcError"></div>Enter the Gift Certificate number<br><input type="text" placeholder="enter GC number" id="gcNum" name="gcNum" size="20"><br><br><a href="#" class="GCbutton" id="pmGiftCert">APPLY</a> <a class="GCbutton" id="gcBal" href="#">Check Balance</a></td></tr></table></td>
		</tr>
		<tr>
			<td><div id="paymenttype" style="width: 100%;"></div></td>
		</tr>
		</table>
		<table width="960" border="0" align="center" cellpadding="3" cellspacing="0" style="margin-left:8px">
		<tr>
			<td width="63%" height="35" align="left" bgcolor="#FF0000"><span class="style1"> Special Instructions</span></td>
		</tr>
		<tr>
			<td width="63%" height="35" align="left" valign="middle" bgcolor="#FFFFFF"><small><em>If you have any special shipping, delivery or other instructions for SoccerOne Customer Service please enter them here...</em></small><textarea name="orderNotes" id="orderNotes" style="width:99%;height:100px;"></textarea></td>
		</tr>
		</table>
		<table width="960" border="0" align="center" cellpadding="3" cellspacing="0" style="margin-left:8px">
		<tr>
			<td width="63%" height="35" align="left" bgcolor="#FF0000"><span class="style1">Terms and Conditions</span></td>
		</tr>
		<tr>
    		<td width="60%" height="35" align="left" valign="middle" bgcolor="#FFFFFF"><p><b>Returns and Exchanges</b><br />
Customer must notify SoccerOne seven days after receiving their order for all claims regarding shortages or defective merchandise. Any defective items will be replaced immediately, upon the return of that item with a copy of your invoice. SoccerOne will not accept packages returned C.O.D. SoccerOne will honor the manufacturer's guarantee on any of their products originally purchased from us. Returns due to customer error may result in a 15% restocking charge.</p>
			<p>A Return Authorization Number is required for all returns and exchanges. Please call us at (888) 297-6386 or email <a href="mailto:customerservice@soccerone.com">Customer Service</a>, prior to sending anything back.</p>
			<p><b>Custom Products &amp; Uniforms</b><br />
Products that are personalized, imprinted, or made to order are cannot be returned or refunded. This includes, but not limited to, products such as numbered uniforms, embroidered team wear, logo on soccer balls, imprinted bags, etc.</p>
			<p><b>Backorders</b><br />
From time to time, SoccerOne may run out of a specific inventory item. Unless otherwise specified the balance of your order will be shipped and invoiced and the out of stock item will be shipped at a later date. This process, called backordering, will be shipped at regular ground rates and will not adversely effect any quantity discount pricing. You may cancel an item on backorder at any time.</p></td>
		</tr>
		</table>
		<table width="950" border="0" align="center" cellpadding="3" cellspacing="0">
		<tr>
    		<td width="3%" height="35" align="left" valign="middle" bgcolor="#FFFFFF"><p><input type="checkbox" id="agree" name="agree" /></p></td>
			<td width="97%" align="left" valign="middle" bgcolor="#FFFFFF">I have read, understand and agree with all terms and conditions.</td>
		</tr>
		<tr>
			<td colspan="2" style="text-align: right;"><input type="hidden" name="submitted" value="1" /><input class="shoppingcart" type="button" id="SubmitOrder" name="SubmitOrder" value="Submit Order" /></td>
		</tr>
		</table>
	</form>
<?php 	
		// } // end of main while loop
	} else {
?>
	<br /><br />
	<h1><span style="color: rgb(255, 0, 0);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sorry, but your shopping cart is empty!</span></h1>
	<br /><br /><br /><br /><br /><br />
<?php 
	}
} 
?>
	</div>    
	<div class="clear"></div>
</div>
	<div class="footer">
		<div class="foot_box"><?php include_once("includes/footer.php"); ?></div>
	</div>
</div>
</body>
<?php mysql_close($conn); ?>